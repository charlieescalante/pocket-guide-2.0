import streamlit as st
from openai import OpenAI
from streamlit_geolocation import streamlit_geolocation
import os
import time
import base64

# Initialize OpenAI client
client = OpenAI(api_key=st.secrets['OPENAI_API_Key'])

# Title and Information
st.title("PocketGuide with Voice")
st.info(
    "**Note**: The content presented here is generated by AI, and any spoken narration uses an AI-generated voice."
)

# Initialize session states
if "step" not in st.session_state:
    st.session_state.step = 0  # Step 0: Initial state, Step 1: GPS retrieved

if "location" not in st.session_state:
    st.session_state.location = None

if "messages" not in st.session_state:
    st.session_state.messages = [
        {
            "role": "system",
            "content": (
                "You are a tour guide. Provide detailed insights into a user's surroundings "
                "based on GPS coordinates. Speak as though you've lived there your entire life, "
                "with rich detail and history."
            ),
        }
    ]

# Function: Text-to-Speech
def text_to_speech(input_text):
    response = client.audio.speech.create(
        model="tts-1",
        voice="nova",
        input=input_text
    )
    audio_file_path = "temp_audio.mp3"
    with open(audio_file_path, "wb") as f:
        response.stream_to_file(audio_file_path)
    return audio_file_path

# Function: Autoplay Audio
def autoplay_audio(file_path):
    with open(file_path, "rb") as f:
        data = f.read()
    b64 = base64.b64encode(data).decode("utf-8")
    md = f"""
    <audio autoplay>
    <source src="data:audio/mp3;base64,{b64}" type="audio/mp3">
    </audio>
    """
    st.markdown(md, unsafe_allow_html=True)

# Function: Retrieve Location
def get_location():
    with st.spinner("Fetching geolocation..."):
        location = None
        retries = 10  # Max retries to wait for the location
        while retries > 0:
            location = streamlit_geolocation()
            if location and location["latitude"] and location["longitude"]:
                return location
            time.sleep(1)  # Wait before retrying
            retries -= 1
        return None

# Double-Action Button Logic
if st.session_state.step == 0:  # Step 0: GPS Retrieval
    if st.button("Start Tour"):
        location = get_location()
        if location:
            st.success("Geolocation Retrieved Successfully!")
            st.session_state.location = location
            st.session_state.step = 1  # Move to the next step
        else:
            st.error("Unable to retrieve geolocation. Please ensure location services are enabled.")

elif st.session_state.step == 1:  # Step 1: Push to OpenAI
    lat = st.session_state.location["latitude"]
    lon = st.session_state.location["longitude"]

    st.write(f"**Latitude:** {lat}")
    st.write(f"**Longitude:** {lon}")

    # Button to trigger OpenAI call
    if st.button("Generate Tour"):
        # Prepare user input for OpenAI
        user_message = f"My current GPS coordinates are: Latitude {lat}, Longitude {lon}."
        st.session_state.messages.append({"role": "user", "content": user_message})

        # Call OpenAI ChatCompletion
        with st.spinner("Generating your tour guide narration..."):
            chatresponse = client.chat.completions.create(
                model="gpt-4",
                messages=st.session_state.messages,
                temperature=1,
                n=1,
            )

        # Extract and display the assistantâ€™s response
        tour_guide_text = chatresponse.choices[0].message.content
        st.session_state.messages.append({"role": "assistant", "content": tour_guide_text})

        st.write("---")
        st.markdown("#### Your PocketGuide says:")
        st.write(tour_guide_text)

        # Generate and play audio
        with st.spinner("Generating audio..."):
            audio_file = text_to_speech(tour_guide_text)
            autoplay_audio(audio_file)
            os.remove(audio_file)

        # Reset the steps for another tour
        st.session_state.step = 0
